{"version":3,"file":"audio-src.js","sources":["../src/check/hds.js","../src/check/hls.js","../src/check/mse.js","../src/index.js"],"sourcesContent":["/**\r\n * HDSを再生できるか\r\n * @param {Audio} audio\r\n * @return {Boolean} true : OK / false / NG\r\n */\r\nexport default function is_can_play_hds(audio) {\r\n  return audio.canPlayType('application/f4m+xml') === 'maybe';\r\n}\r\n","\r\n/**\r\n * HLSを再生できるか\r\n * @param {Audio} audio\r\n * @return {Boolean} true : OK / false / NG\r\n */\r\nexport default function is_can_play_hls(audio) {\r\n  return audio.canPlayType('application/vnd.apple.mpegURL') === 'maybe';\r\n}\r\n","\r\n/** ************\r\n * MediaSourceExtensionに対応しているか\r\n * @return {Boolean} true : OK / false / NG\r\n */\r\n/* eslint no-void:[\"off\"] */\r\n\r\nexport default function is_support_mse() {\r\n  const hasWebKit = (window.WebKitMediaSource !== null && window.WebKitMediaSource !== void 0);\r\n  const hasMediaSource = (window.MediaSource !== null && window.MediaSource !== void 0);\r\n  return (hasWebKit || hasMediaSource);\r\n}\r\n","/**\r\n * ユーザー環境をチェックして、HDS / HLS / dash.js のソースを HTML5 Audio にセットする\r\n * MPEG-DASHを使う場合は dash.js が必要。\r\n *\r\n *\r\n * @author   Hiroshi Fukuda <info.sygnas@gmail.com>\r\n * @license  MIT\r\n */\r\n\r\n/* globals dashjs */\r\n\r\nimport check_hds from './check/hds';\r\nimport check_hls from './check/hls';\r\nimport check_mse from './check/mse';\r\n\r\n\r\nexport default class {\r\n  /**\r\n   * コンストラクタ\r\n   * @param {Object} config インスタンス設定。this.defaults 参照\r\n   */\r\n  constructor(config) {\r\n    // オーディオソースのタイプ定数\r\n    this.TYPE_HDS = 'hds';\r\n    this.TYPE_HLS = 'hls';\r\n    this.TYPE_MSE = 'mse';\r\n    this.TYPE_FILE = 'file';\r\n\r\n    // デフォルト設定\r\n    const defaults = {\r\n      hds: {\r\n        protcol: 'http://',\r\n        playlist: '/manifest.f4m',\r\n      },\r\n      hls: {\r\n        protcol: 'http://',\r\n        playlist: '/playlist.m3u8',\r\n      },\r\n      mse: {\r\n        protcol: 'http://',\r\n        playlist: '/manifest.mpd',\r\n        autoplay: false,\r\n      },\r\n    };\r\n    // 設定反映\r\n    this.opt = Object.assign(defaults, config);\r\n\r\n    this.audio = new Audio(); // HTML5 Audio\r\n    this.dash_player = null; // dash.js のインスタンス\r\n    this.is_support_hds = false; // HDSを再生できるか\r\n    this.is_support_hls = false; // HLSを再生できるか\r\n    this.is_support_mse = false; // MedisSourceExtensionに対応しているか\r\n    this.now_type = null; // ソースとして設定されたタイプ。TYPE_HDS ... TYPE_FILE などが入る\r\n\r\n    this.$_check_support_result = null; // check_support() の実行結果\r\n  }\r\n\r\n  /**\r\n   * サポート環境チェック\r\n   * @return {Boolean} true: チェック完了 / false: 対象外環境\r\n   */\r\n  check_support() {\r\n    // すでに実行していたらその結果を返す\r\n    if (this.$_check_support_result !== null) return this.$_check_support_result;\r\n\r\n    try {\r\n      this.is_support_hds = check_hds(this.audio); // HDSを再生できるか\r\n      this.is_support_hls = check_hls(this.audio); // HLSを再生できるか\r\n      this.is_support_mse = check_mse(this.audio); // MedisSourceExtensionに対応しているか\r\n    } catch (e) {\r\n      this.$_check_support_result = false;\r\n      return false;\r\n    }\r\n    this.$_check_support_result = true;\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * オーディオソースを渡してHTML5 Audioにセットする\r\n   * @param {String} url\r\n   * mp3/ogg など非ストリーミングの場合はファイルのURL。\r\n   * ストリーミングの場合は http://\b{この部分}//manifest.f4m をベースURLとして渡す\r\n   * @param {String} type\r\n   * タイプを指定したい時は TYPE_HDS などを渡す。\r\n   * 非ストリーミングの場合は TYPE_FILE を必ず渡す。\r\n   */\r\n  set_src(url, type = null) {\r\n    if (type === this.TYPE_FILE) {\r\n      return this.$_set_src_file(url);\r\n    } else if (type === this.TYPE_HLS) {\r\n      return this.$_set_src_hls(url);\r\n    } else if (type === this.TYPE_HDS) {\r\n      return this.$_set_src_hds(url);\r\n    } else if (type === this.TYPE_MSE) {\r\n      return this.$_set_src_mse(url);\r\n    } else if (this.is_support_hls) {\r\n      return this.$_set_src_hls(url);\r\n    } else if (this.is_support_hds) {\r\n      return this.$_set_src_hds(url);\r\n    } else if (this.is_support_mse) {\r\n      return this.$_set_src_mse(url);\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * private\r\n   */\r\n\r\n  /**\r\n   * 非ストリーミングでセットする\r\n   * @param {String} url\r\n   */\r\n  $_set_src_file(url) {\r\n    this.audio.src = url;\r\n    this.now_type = this.TYPE_FILE;\r\n    return true;\r\n  }\r\n  /**\r\n   * HLS形式でセットする\r\n   * @param {String} url\r\n   */\r\n  $_set_src_hls(url) {\r\n    if (!this.is_support_hls) return false;\r\n\r\n    this.audio.src = this.opt.hls.protcol + url + this.opt.hls.playlist;\r\n    this.now_type = this.TYPE_HLS;\r\n    return true;\r\n  }\r\n  /**\r\n   * HDS形式でセットする\r\n   * @param {String} url\r\n   */\r\n  $_set_src_hds(url) {\r\n    if (!this.is_support_hds) return false;\r\n\r\n    this.audio.src = this.opt.hds.protcol + url + this.opt.hds.playlist;\r\n    this.now_type = this.TYPE_HDS;\r\n    return true;\r\n  }\r\n  /**\r\n   * MSE形式でセットする\r\n   * @param {String} url\r\n   */\r\n  $_set_src_mse(url) {\r\n    if (!this.is_support_mse) return false;\r\n\r\n    // dash.js を使う\r\n    this.now_type = this.TYPE_MSE;\r\n    const src = this.opt.mse.protcol + url + this.opt.mse.playlist;\r\n\r\n    if (this.dash_player === null) {\r\n      this.dash_player = dashjs.MediaPlayer().create();\r\n      this.dash_player.initialize(this.audio, src, this.opt.mse.autoplay);\r\n    } else {\r\n      this.dash_player.attachSource(src);\r\n    }\r\n    return true;\r\n  }\r\n}\r\n"],"names":["is_can_play_hds","audio","canPlayType","is_can_play_hls","is_support_mse","hasWebKit","window","WebKitMediaSource","hasMediaSource","MediaSource","config","TYPE_HDS","TYPE_HLS","TYPE_MSE","TYPE_FILE","defaults","opt","Object","assign","Audio","dash_player","is_support_hds","is_support_hls","now_type","$_check_support_result","check_hds","check_hls","check_mse","e","url","type","$_set_src_file","$_set_src_hls","$_set_src_hds","$_set_src_mse","src","hls","protcol","playlist","hds","mse","dashjs","MediaPlayer","create","initialize","autoplay","attachSource"],"mappings":"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"}